import requests
import random
import time
import json
from datetime import datetime, timedelta

# API è¨­å®š
BASE_URL = "http://127.0.0.1:5000/api"

# ==========================================
# 1. è³‡æ–™åº«ä¾†æº (å°æ‡‰ options.js)
# ==========================================
TAIWAN_PLACES = {
  "åŸºéš†å¸‚": ["ä»æ„›å€", "ä¿¡ç¾©å€", "ä¸­æ­£å€", "ä¸­å±±å€", "å®‰æ¨‚å€", "æš–æš–å€", "ä¸ƒå µå€"],
  "å°åŒ—å¸‚": ["ä¸­æ­£å€", "å¤§åŒå€", "ä¸­å±±å€", "æ¾å±±å€", "å¤§å®‰å€", "è¬è¯å€", "ä¿¡ç¾©å€", "å£«æ—å€", "åŒ—æŠ•å€", "å…§æ¹–å€", "å—æ¸¯å€", "æ–‡å±±å€"],
  "æ–°åŒ—å¸‚": ["è¬é‡Œå€", "é‡‘å±±å€", "æ¿æ©‹å€", "æ±æ­¢å€", "æ·±å‘å€", "çŸ³ç¢‡å€", "ç‘èŠ³å€", "å¹³æºªå€", "é›™æºªå€", "è²¢å¯®å€", "æ–°åº—å€", "åªæ—å€", "çƒä¾†å€", "æ°¸å’Œå€", "ä¸­å’Œå€", "åœŸåŸå€", "ä¸‰å³½å€", "æ¨¹æ—å€", "é¶¯æ­Œå€", "ä¸‰é‡å€", "æ–°èŠå€", "æ³°å±±å€", "æ—å£å€", "è˜†æ´²å€", "äº”è‚¡å€", "å…«é‡Œå€", "æ·¡æ°´å€", "ä¸‰èŠå€", "çŸ³é–€å€"],
  "æ¡ƒåœ’å¸‚": ["ä¸­å£¢å€", "å¹³é®å€", "é¾æ½­å€", "æ¥Šæ¢…å€", "æ–°å±‹å€", "è§€éŸ³å€", "æ¡ƒåœ’å€", "é¾œå±±å€", "å…«å¾·å€", "å¤§æºªå€", "å¾©èˆˆå€", "å¤§åœ’å€", "è˜†ç«¹å€"],
  "æ–°ç«¹å¸‚": ["æ±å€", "åŒ—å€", "é¦™å±±å€"],
  "æ–°ç«¹ç¸£": ["ç«¹åŒ—å¸‚", "æ¹–å£é„‰", "æ–°è±é„‰", "æ–°åŸ”é®", "é—œè¥¿é®", "èŠæ—é„‰", "å¯¶å±±é„‰", "ç«¹æ±é®", "äº”å³°é„‰", "æ©«å±±é„‰", "å°–çŸ³é„‰", "åŒ—åŸ”é„‰", "å³¨çœ‰é„‰"],
  "è‹—æ —ç¸£": ["ç«¹å—é®", "é ­ä»½å¸‚", "ä¸‰ç£é„‰", "å—åº„é„‰", "ç…æ½­é„‰", "å¾Œé¾é®", "é€šéœ„é®", "è‹‘è£¡é®", "è‹—æ —å¸‚", "é€ æ©‹é„‰", "é ­å±‹é„‰", "å…¬é¤¨é„‰", "å¤§æ¹–é„‰", "æ³°å®‰é„‰", "éŠ…é‘¼é„‰", "ä¸‰ç¾©é„‰", "è¥¿æ¹–é„‰", "å“è˜­é®"],
  "å°ä¸­å¸‚": ["ä¸­å€", "æ±å€", "å—å€", "è¥¿å€", "åŒ—å€", "åŒ—å±¯å€", "è¥¿å±¯å€", "å—å±¯å€", "å¤ªå¹³å€", "å¤§é‡Œå€", "éœ§å³°å€", "çƒæ—¥å€", "è±åŸå€", "åé‡Œå€", "çŸ³å²¡å€", "æ±å‹¢å€", "å’Œå¹³å€", "æ–°ç¤¾å€", "æ½­å­å€", "å¤§é›…å€", "ç¥å²¡å€", "å¤§è‚šå€", "æ²™é¹¿å€", "é¾äº•å€", "æ¢§æ£²å€", "æ¸…æ°´å€", "å¤§ç”²å€", "å¤–åŸ”å€", "å¤§å®‰å€"],
  "å½°åŒ–ç¸£": ["å½°åŒ–å¸‚", "èŠ¬åœ’é„‰", "èŠ±å£‡é„‰", "ç§€æ°´é„‰", "é¹¿æ¸¯é®", "ç¦èˆˆé„‰", "ç·šè¥¿é„‰", "å’Œç¾é®", "ä¼¸æ¸¯é„‰", "å“¡æ—å¸‚", "ç¤¾é ­é„‰", "æ°¸é–é„‰", "åŸ”å¿ƒé„‰", "æºªæ¹–é®", "å¤§æ‘é„‰", "åŸ”é¹½é„‰", "ç”°ä¸­é®", "åŒ—æ–—é®", "ç”°å°¾é„‰", "åŸ¤é ­é„‰", "æºªå·é„‰", "ç«¹å¡˜é„‰", "äºŒæ—é®", "å¤§åŸé„‰", "èŠ³è‹‘é„‰", "äºŒæ°´é„‰"],
  "å—æŠ•ç¸£": ["å—æŠ•å¸‚", "ä¸­å¯®é„‰", "è‰å±¯é®", "åœ‹å§“é„‰", "åŸ”é‡Œé®", "ä»æ„›é„‰", "åé–“é„‰", "é›†é›†é®", "æ°´é‡Œé„‰", "é­šæ± é„‰", "ä¿¡ç¾©é„‰", "ç«¹å±±é®", "é¹¿è°·é„‰"],
  "é›²æ—ç¸£": ["æ–—å—é®", "å¤§åŸ¤é„‰", "è™å°¾é®", "åœŸåº«é®", "è¤’å¿ é„‰", "æ±å‹¢é„‰", "å°è¥¿é„‰", "å´™èƒŒé„‰", "éº¥å¯®é„‰", "æ–—å…­å¸‚", "æ—å…§é„‰", "å¤å‘é„‰", "è¿æ¡é„‰", "è¥¿èºé®", "äºŒå´™é„‰", "åŒ—æ¸¯é®", "æ°´æ—é„‰", "å£æ¹–é„‰", "å››æ¹–é„‰", "å…ƒé•·é„‰"],
  "å˜‰ç¾©å¸‚": ["æ±å€", "è¥¿å€"],
  "å˜‰ç¾©ç¸£": ["ç•ªè·¯é„‰", "æ¢…å±±é„‰", "ç«¹å´é„‰", "é˜¿é‡Œå±±é„‰", "ä¸­åŸ”é„‰", "å¤§åŸ”é„‰", "æ°´ä¸Šé„‰", "é¹¿è‰é„‰", "å¤ªä¿å¸‚", "æœ´å­å¸‚", "æ±çŸ³é„‰", "å…­è…³é„‰", "æ–°æ¸¯é„‰", "æ°‘é›„é„‰", "å¤§æ—é®", "æºªå£é„‰", "ç¾©ç«¹é„‰", "å¸ƒè¢‹é®"],
  "å°å—å¸‚": ["ä¸­è¥¿å€", "æ±å€", "å—å€", "åŒ—å€", "å®‰å¹³å€", "å®‰å—å€", "æ°¸åº·å€", "æ­¸ä»å€", "æ–°åŒ–å€", "å·¦é®å€", "ç‰äº•å€", "æ¥ è¥¿å€", "å—åŒ–å€", "ä»å¾·å€", "é—œå»Ÿå€", "é¾å´å€", "å®˜ç”°å€", "éº»è±†å€", "ä½³é‡Œå€", "è¥¿æ¸¯å€", "ä¸ƒè‚¡å€", "å°‡è»å€", "å­¸ç”²å€", "åŒ—é–€å€", "æ–°ç‡Ÿå€", "å¾Œå£å€", "ç™½æ²³å€", "æ±å±±å€", "å…­ç”²å€", "ä¸‹ç‡Ÿå€", "æŸ³ç‡Ÿå€", "é¹½æ°´å€", "å–„åŒ–å€", "å¤§å…§å€", "å±±ä¸Šå€", "æ–°å¸‚å€", "å®‰å®šå€"],
  "é«˜é›„å¸‚": ["æ–°èˆˆå€", "å‰é‡‘å€", "è‹“é›…å€", "é¹½åŸ•å€", "é¼“å±±å€", "æ——æ´¥å€", "å‰é®å€", "ä¸‰æ°‘å€", "æ¥ æ¢“å€", "å°æ¸¯å€", "å·¦ç‡Ÿå€", "ä»æ­¦å€", "å¤§ç¤¾å€", "æ±æ²™ç¾¤å³¶", "å—æ²™ç¾¤å³¶", "å²¡å±±å€", "è·¯ç«¹å€", "é˜¿è“®å€", "ç”°å¯®å€", "ç‡•å·¢å€", "æ©‹é ­å€", "æ¢“å®˜å€", "å½Œé™€å€", "æ°¸å®‰å€", "æ¹–å…§å€", "é³³å±±å€", "å¤§å¯®å€", "æ—åœ’å€", "é³¥æ¾å€", "å¤§æ¨¹å€", "æ——å±±å€", "ç¾æ¿ƒå€", "å…­é¾œå€", "å…§é–€å€", "æ‰æ—å€", "ç”²ä»™å€", "æ¡ƒæºå€", "é‚£ç‘ªå¤å€", "èŒ‚æ—å€", "èŒ„è£å€"],
  "å±æ±ç¸£": ["å±æ±å¸‚", "ä¸‰åœ°é–€é„‰", "éœ§å°é„‰", "ç‘ªå®¶é„‰", "ä¹å¦‚é„‰", "é‡Œæ¸¯é„‰", "é«˜æ¨¹é„‰", "é¹½åŸ”é„‰", "é•·æ²»é„‰", "éºŸæ´›é„‰", "ç«¹ç”°é„‰", "å…§åŸ”é„‰", "è¬ä¸¹é„‰", "æ½®å·é®", "æ³°æ­¦é„‰", "ä¾†ç¾©é„‰", "è¬å·’é„‰", "å´é ‚é„‰", "æ–°åŸ¤é„‰", "å—å·é„‰", "æ—é‚Šé„‰", "æ±æ¸¯é®", "ç‰çƒé„‰", "ä½³å†¬é„‰", "æ–°åœ’é„‰", "æ‹å¯®é„‰", "æ‹å±±é„‰", "æ˜¥æ—¥é„‰", "ç…å­é„‰", "è»ŠåŸé„‰", "ç‰¡ä¸¹é„‰", "æ†æ˜¥é®", "æ»¿å·é„‰"],
  "å®œè˜­ç¸£": ["å®œè˜­å¸‚", "é ­åŸé®", "ç¤æºªé„‰", "å£¯åœé„‰", "å“¡å±±é„‰", "ç¾…æ±é®", "ä¸‰æ˜Ÿé„‰", "å¤§åŒé„‰", "äº”çµé„‰", "å†¬å±±é„‰", "è˜‡æ¾³é®", "å—æ¾³é„‰", "é‡£é­šè‡ºåˆ—å¶¼"],
  "èŠ±è“®ç¸£": ["èŠ±è“®å¸‚", "æ–°åŸé„‰", "ç§€æ—é„‰", "å‰å®‰é„‰", "å£½è±é„‰", "é³³æ—é®", "å…‰å¾©é„‰", "è±æ¿±é„‰", "ç‘ç©—é„‰", "è¬æ¦®é„‰", "ç‰é‡Œé®", "å“æºªé„‰", "å¯Œé‡Œé„‰"],
  "å°æ±ç¸£": ["å°æ±å¸‚", "ç¶ å³¶é„‰", "è˜­å¶¼é„‰", "å»¶å¹³é„‰", "å‘å—é„‰", "é¹¿é‡é„‰", "é—œå±±é®", "æµ·ç«¯é„‰", "æ± ä¸Šé„‰", "æ±æ²³é„‰", "æˆåŠŸé®", "é•·æ¿±é„‰", "å¤ªéº»é‡Œé„‰", "é‡‘å³°é„‰", "å¤§æ­¦é„‰", "é”ä»é„‰"],
  "æ¾æ¹–ç¸£": ["é¦¬å…¬å¸‚", "è¥¿å¶¼é„‰", "æœ›å®‰é„‰", "ä¸ƒç¾é„‰", "ç™½æ²™é„‰", "æ¹–è¥¿é„‰"],
  "é‡‘é–€ç¸£": ["é‡‘æ²™é®", "é‡‘æ¹–é®", "é‡‘å¯§é„‰", "é‡‘åŸé®", "çƒˆå¶¼é„‰", "çƒåµé„‰"],
  "é€£æ±Ÿç¸£": ["å—ç«¿é„‰", "åŒ—ç«¿é„‰", "è’å…‰é„‰", "æ±å¼•é„‰"]
}

OCCUPATIONS = [
    "æ°‘æ„ä»£è¡¨ã€ä¸»ç®¡åŠç¶“ç†äººå“¡", "å°ˆæ¥­äººå“¡", "æŠ€è¡“å“¡åŠåŠ©ç†å°ˆæ¥­äººå“¡",
    "äº‹å‹™æ”¯æ´äººå“¡", "æœå‹™åŠéŠ·å”®å·¥ä½œäººå“¡", "è¾²ã€æ—ã€æ¼ã€ç‰§æ¥­ç”Ÿç”¢äººå“¡",
    "æŠ€è—æœ‰é—œå·¥ä½œäººå“¡", "æ©Ÿæ¢°è¨­å‚™æ“ä½œåŠçµ„è£äººå“¡", "åŸºå±¤æŠ€è¡“å·¥åŠå‹åŠ›å·¥",
    "è»äºº", "å…¶ä»– / å­¸ç”Ÿ / å¾…æ¥­"
]

TRANSPORT_OPTIONS = {
    "private": ["scooter_gas", "scooter_electric", "car_gas", "car_electric", "bike"],
    "public": ["bus", "mrt", "train", "hsr", "airplane_domestic"]
}

# ==========================================
# 2. éš¨æ©Ÿç”Ÿæˆè¼”åŠ©å‡½å¼
# ==========================================

def get_random_birthdate():
    """ç”Ÿæˆ 18 ~ 80 æ­²ä¹‹é–“çš„ç”Ÿæ—¥"""
    current_year = datetime.now().year
    start_year = current_year - 80
    end_year = current_year - 18
    year = random.randint(start_year, end_year)
    month = random.randint(1, 12)
    day = random.randint(1, 28) # ç°¡åŒ–è™•ç†ï¼Œé¿å… 2/29 å•é¡Œ
    return f"{year}-{month:02d}-{day:02d}"

def get_reasonable_diet():
    """ç”Ÿæˆåˆç†çš„é£²é£Ÿæ•¸æ“š (ä¸€é€±ç´„ 21 é¤)"""
    total_meals = 21 # å‡è¨­ä¸€å¤© 3 é¤
    meat = random.randint(0, 14) # è‚‰é¡ 0~14 é¤
    veg = random.randint(2, total_meals - meat) # å‰©ä¸‹åˆ†çµ¦ç´ é£Ÿ
    grain = total_meals - meat - veg # å‰©ä¸‹çµ¦è¼•é£Ÿ/æ¾±ç²‰
    
    # å¾®èª¿ï¼šé¿å…å®Œå…¨æ¥µç«¯
    if meat > 10: # è‚‰é£Ÿè€…
        veg = random.randint(2, 5)
    
    return {"meat": meat, "veg": veg, "grain": grain}

def get_reasonable_transport(city):
    """æ ¹æ“šåŸå¸‚èˆ‡é‚è¼¯ç”Ÿæˆäº¤é€šæ•¸æ“š"""
    # æ±ºå®šæ˜¯å¤§çœ¾é‹è¼¸é‚„æ˜¯ç§äººé‹å…·
    # é›™åŒ—åœ°å€å¤§çœ¾é‹è¼¸æ©Ÿç‡é«˜
    is_metro = city in ["å°åŒ—å¸‚", "æ–°åŒ—å¸‚"]
    if is_metro and random.random() > 0.4:
        trans_type = random.choice(["mrt", "bus", "public"])
        km = random.randint(200, 600) # é€šå‹¤é‡Œç¨‹
    else:
        # å…¶ä»–åœ°å€æˆ–éš¨æ©Ÿé¸æ“‡ç§äºº
        trans_type = random.choice(TRANSPORT_OPTIONS["private"] + TRANSPORT_OPTIONS["public"])
        
        # æ ¹æ“šé‹å…·èª¿æ•´é‡Œç¨‹
        if trans_type == "bike":
            km = random.randint(10, 50) # èµ°è·¯/å–®è»Šä¸æœƒå¤ªé 
        elif "scooter" in trans_type:
            km = random.randint(150, 500)
        elif "car" in trans_type:
            km = random.randint(300, 1200) # é–‹è»Šå¯èƒ½è·¨ç¸£å¸‚
        elif "hsr" in trans_type or "airplane" in trans_type:
            km = random.randint(200, 1000) # é«˜éµ/é£›æ©Ÿé‡Œç¨‹è¼ƒé•·
        else:
            km = random.randint(100, 400)

    return {"type": trans_type, "km": km}

def generate_random_user(index):
    """ç”Ÿæˆå®Œæ•´ä½¿ç”¨è€…è³‡æ–™"""
    city = random.choice(list(TAIWAN_PLACES.keys()))
    district = random.choice(TAIWAN_PLACES[city])
    
    return {
        "username": f"user_auto_{index}_{random.randint(1000, 9999)}",
        "email": f"auto_{index}_{random.randint(1000,9999)}@test.com",
        "password": "password123",
        "fullName": f"æ¸¬è©¦å“¡{index:03d}",
        "gender": random.choice(["Male", "Female", "Other"]),
        "city": city,
        "district": district,
        "birthdate": get_random_birthdate(),
        "occupation": random.choice(OCCUPATIONS)
    }

def generate_detailed_data(user_profile):
    """ç”Ÿæˆè©³ç´°ç¢³æ’è¼¸å…¥è³‡æ–™"""
    city = user_profile['city']
    
    # 1. èƒ½æº (Energy)
    # å—éƒ¨è¼ƒç†±ï¼Œé›»è²»å¯èƒ½è¼ƒé«˜ï¼›åŒ—éƒ¨å†¬å¤©å¯èƒ½æœ‰æš–æ°£
    base_elec = random.randint(150, 400)
    if city in ["é«˜é›„å¸‚", "å±æ±ç¸£", "å°å—å¸‚"]:
        base_elec += random.randint(50, 150) # å†·æ°£åŠ æˆ
    
    energy = {
        "electricity": base_elec,
        "gas": random.randint(10, 30), # ç“¦æ–¯ (æ´—æ¾¡/ç…®é£¯)
        "water": random.randint(10, 30) # æ°´
    }

    # 2. äº¤é€š (Transport)
    transport = get_reasonable_transport(city)

    # 3. é£²é£Ÿ (Diet)
    diet = get_reasonable_diet()

    # 4. æ¶ˆè²» (Consumption)
    # è·æ¥­å½±éŸ¿æ¶ˆè²»åŠ› (ç°¡å–®æ¨¡æ“¬)
    if "ç¶“ç†" in user_profile['occupation'] or "å°ˆæ¥­äººå“¡" in user_profile['occupation']:
        consumption = {
            "clothes": random.randint(2000, 8000),
            "electronics": random.randint(1000, 5000)
        }
    elif "å­¸ç”Ÿ" in user_profile['occupation']:
        consumption = {
            "clothes": random.randint(500, 2000),
            "electronics": random.randint(200, 1000)
        }
    else:
        consumption = {
            "clothes": random.randint(1000, 4000),
            "electronics": random.randint(500, 2000)
        }

    # 5. å»¢æ£„ç‰© (Waste)
    # éš¨æ©Ÿç”Ÿæˆï¼Œä½†é€šå¸¸åƒåœ¾é‡èˆ‡å›æ”¶é‡æˆåæ¯”æˆ–æ­£æ¯”
    bags = random.randint(1, 5)
    recycle = random.randint(2, 8)

    return {
        "energy": energy,
        "transport": transport,
        "diet": diet,
        "consumption": consumption,
        "waste": {"bags": bags, "recycle": recycle}
    }

# ==========================================
# 3. ä¸»ç¨‹å¼
# ==========================================
def main():
    print("ğŸš€ é–‹å§‹ç”Ÿæˆ 100 ä»½éš¨æ©Ÿæ¸¬è©¦è³‡æ–™...")
    success_count = 0
    session = requests.Session()

    for i in range(1, 101):
        try:
            # A. è¨»å†Š
            user_data = generate_random_user(i)
            # print(f"[{i}/100] è¨»å†Šä¸­: {user_data['city']} {user_data['district']} - {user_data['occupation']}")
            
            reg_res = session.post(f"{BASE_URL}/register", json=user_data)
            
            if reg_res.status_code == 201:
                # B. ç™»å…¥
                login_data = {
                    "username": user_data["username"],
                    "password": user_data["password"]
                }
                login_res = session.post(f"{BASE_URL}/login", json=login_data)
                
                if login_res.status_code == 200:
                    # C. è¨ˆç®—è©³ç´°ç¢³æ’
                    calc_data = generate_detailed_data(user_data)
                    calc_res = session.post(f"{BASE_URL}/calculate/detailed", json=calc_data)
                    
                    if calc_res.status_code == 200:
                        result = calc_res.json()
                        print(f"âœ… [{i:03d}] æˆåŠŸ: {user_data['city']} {user_data['district']} | ç¢³æ’: {result['total']} kg")
                        success_count += 1
                    else:
                        print(f"âŒ [{i:03d}] è¨ˆç®—å¤±æ•—: {calc_res.text}")
                else:
                    print(f"âŒ [{i:03d}] ç™»å…¥å¤±æ•—")
            elif reg_res.status_code == 409:
                print(f"âš ï¸ [{i:03d}] å¸³è™Ÿå·²å­˜åœ¨ï¼Œè·³é")
            else:
                print(f"âŒ [{i:03d}] è¨»å†Šå¤±æ•—: {reg_res.text}")

        except Exception as e:
            print(f"ğŸ”¥ [{i:03d}] é€£ç·šéŒ¯èª¤: {e}")
            break # å¦‚æœé€£ç·šæ›äº†å°±åœæ­¢ï¼Œé¿å…æ´—ç‰ˆ

    print(f"\nğŸ‰ ä»»å‹™çµæŸï¼æˆåŠŸç”Ÿæˆ {success_count} ç­†è³‡æ–™ã€‚")

if __name__ == "__main__":
    main()